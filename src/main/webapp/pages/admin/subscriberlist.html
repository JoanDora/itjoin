<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" type="text/css"
	href="/resources/css/easyui/icon.css" />
<link rel="stylesheet" type="text/css"
	href="/resources/css/easyui/easyui.css">
<script type="text/javascript"
	src="/resources/js/jquery/jquery-1.10.2.js"></script>
	<script type="text/javascript" src="/resources/js/jquery/jquery-form.js"></script>
<script type="text/javascript" src="/resources/js/jquery.easyui.min.js"></script>
<script type="text/javascript" src="/resources/js/escar/datefmt.js"></script>
<script type="text/javascript" src="/resources/js/easyui-lang-zh_CN.js"></script>

<script>
var adminRole='0';
	$(function() {
		
		
		jQuery.ajax({  
		    type : 'POST',  
		    contentType : 'application/json',  
		    url : '/admin/getSessionUser',
		    dataType : 'json',  
		    success : function(data) 
		    { 
		      if(data!=null && data.id!=null){
		    	  $("#adminPhone").html(data.phone);
		    	  adminRole = data.role;
		      }
		      datagrid();
		    }
		} );
		
		

	});
	
	
	 function formatDatebox(value) {
         if (value == null || value == '') {
             return '';
         }
         var dt;
         if (value instanceof Date) {
             dt = value;
         } else {

             dt = new Date(value);

         }

         return dt.format("yyyy-MM-dd hh:mm:ss"); //扩展的Date的format方法(上述插件实现)
     }
	
	function datagrid(){
		$('#tt').datagrid(
				{
					title : '预约列表',
					iconCls : 'icon-edit',
					pagination : true,//分页控件 
					singleSelect : true,
					rownumbers : true,
					//width : 700,
					height : 'auto',
					url : "/subscriber/getAll?page=0&rows=0",
					columns : [ [
							{
								field : 'user',
								title : '用户名',
								width : 100,
								editor : 'text',
								formatter : function(value) {
									if(value!=null){
										return value.userName;
									}
								
								}
							},
							{
								field : 'userPhone',
								title : '联系电话',
								width : 100,
								editor : 'text',
								formatter : function(value,row,index){
									if(row!=null && row.user!=null){
										return row.user.phone;
									}
								
								}
							},
							{
								field : 'car',
								title : '车辆id',
								width : 200,
								editor : 'text',
								formatter : function(value,row,index){
									if(value!=null){
										return value.id;
									}
										//return value.car.id;
								}
							},
							{
								field : 'car',
								title : '车品牌型号',
								width : 160,
								editor : 'text',
								formatter : function(value) {
									var brandModel ="";
									if(value!=null && value.brand!=null){
										brandModel += value.brand.name;
									}
									if(value !=null && value.brandModel!=null){
										brandModel += value.brandModel.name;
									}
									return brandModel;
								
								}
							},
							{
								field : 'createTime',
								title : '预约时间',
								width : 180,
								editor: 'datebox',
							 formatter: formatDatebox
							},
							{
								field : 'status',
								title : '状态',
								width : 80,
								editor : 'text',
								formatter : function(value) {
									if(value==null){
										return "待看车";
									}else {
										return value;
									}
								
								}
							},
							{
								field : 'action',
								title : '操作',
								width : 100,
								align : 'center',
								formatter : function(value, row, index) {
									/* 	if (row.editing) {
											var s = '<a href="#" onclick="saverow('
													+ index + ')">保存</a> ';
											var c = '<a href="#" onclick="deleterow('
													+ index + ')">删除</a>';
											return s + c;
										} else { */

											
											
									var data = row;
										/* var d = '<a href="#" onclick=editrow('
											+ index + ',"","","","","")>修改状态</a>';  */
											var d="";	
											if(row!=null && row.car!=null){
												 d = '<a href="#" onclick=showcCar("' +row.car.id+'")>查看</a>'; 	
											}
											
									if(adminRole=='1'){
										 
												
										var e = '<a href="#" style="margin-left:20px;" onclick=deleterow('
													+ index + ',"'+row.id+'")>删除</a>'; 
													
										 return  d+e;
									}else{
										return d;
									}
								//	return d
									//}
								}
							} ] ],
					onBeforeEdit : function(index, row) {
						row.editing = true;
						$('#tt').datagrid('refreshRow', index);
						editcount++;
					},
					onAfterEdit : function(index, row) {
						row.editing = false;
						$('#tt').datagrid('refreshRow', index);
						editcount--;
					},
					onCancelEdit : function(index, row) {
						row.editing = false;
						$('#tt').datagrid('refreshRow', index);
						editcount--;
					},
					loadMsg : '数据加载中,请稍候......'
				});

		//分页
		var pager = $('#tt').datagrid('getPager');
		pager.pagination({
			total : 0,
			rows : 0,
			pageNumber : 1,
			pageList : [ 10, 20, 30 ],// 可以设置每页记录条数的列表
			onBeforeRefresh : function() {
			},
			onSelectPage : function(pageNumber, pageSize) {//分页触发  
				//pageNumber--;
				find(pageNumber, pageSize);
			}
		});
	}

	function find(pageNumber, pageSize) {
		$("#tt").datagrid('getPager').pagination({
			pageSize : pageSize,
			pageNumber : pageNumber
		});//重置
		$("#tt").datagrid("loading"); //加屏蔽
		$.ajax({
			type : "POST",
			dataType : "json",
			url : "/subscriber/getAll",
			data : {
				'page' : pageNumber,
				'rows' : pageSize
			},
			success : function(data) {
				$("#tt").datagrid('loadData', pageData(data.rows, data.total));//这里的pageData是我自己创建的一个对象，用来封装获取的总条数，和数据，data.rows是我在控制器里面添加的一个map集合的键的名称
				var total = data.total;
				$("#tt").datagrid("loaded"); //移除屏蔽
			},
			error : function(err) {
				$.messager.alert('操作提示', '获取信息失败...请联系管理员!', 'error');
				$("#tt").datagrid("loaded"); //移除屏蔽
			}
		});
	}

	function pageData(list, total) {
		var obj = new Object();
		obj.total = total;
		obj.rows = list;
		return obj;
	}

	var editcount = 0;
	function editrow(index, id, userName, phone, email, sex) {

		$('#win').window('open');
		$("#adminid").val(id);
		if(userName!='null'){
			$("#adminuserName").val(userName);
		}
		if(phone!='null'){
			$("#adminphone").val(phone);
		}
		if(email!='null'){
			$("#adminemail").val(email);
		}
		if(sex!='null'){
			$("#adminsex").val(sex);
		}
	

		//	$('#tt').datagrid('beginEdit', index);
	}
	function deleterow(index,id) {
		$.messager.confirm('确认', '是否真的删除?', function(r) {
			if (r) {
				$.ajax({
					type : "GET",
					dataType : "json",
					url : "/subscriber/delete/"+id+"?new="+ Math.random(),
					success : function(data) {
						if(data=='1'){
							alert("删除成功");
							$('#tt').datagrid('deleteRow', index);
						}else{
							alert("删除失败");
						}
				
					},
					error : function(err) {
						$.messager.alert('操作提示', '获取信息失败...请联系管理员!', 'error');
					}
				});
				
			

			}
		});
	}
	function saverow(index) {
		$('#tt').datagrid('endEdit', index);
	}
	function cancelrow(index) {
		$('#tt').datagrid('cancelEdit', index);
	}
	function addrow() {
		if (editcount > 0) {
			$.messager.alert('警告', '当前还有' + editcount + '记录正在编辑，不能增加记录。');
			return;
		}
		$('#tt').datagrid('appendRow', {
			phone : '',
			userName : '',
			email : '',
			sex : ''
		});
	}
	function saveall() {
		$('#tt').datagrid('acceptChanges');
	}
	function cancelall() {
		$('#tt').datagrid('rejectChanges');
	}

	$(function() {
		$('#win').window('close');
		//	$('#win').window('open'); // open a window
	});
	
	function clearForm(){
		$('#win').window('close');
	}

	function submitForm(){
		$('#ff').ajaxSubmit({
		    url:'/admin/update',  
			type : "POST",
			dataType: "json",
	        success:function(data){  
                if(data=='1'){
                	alert("操作成功");
                }else{
                	alert("操作失败");
                }
                $('#win').window('close');
                parent.location.reload();
	        }  
	    });   
	}
	
	$('#win').window('close'); 
	
	function showcCar(carId){
		
		   jQuery.ajax({  
		        type : 'GET',  
		        contentType : 'application/json',  
		        url : '/car/find?id='+carId,
		        dataType : 'json',  
		        success : function(data) 
		        { 
		        	console.log(data);
		        	var realPrice = data.realPrice;
		        	var brandModel = "";
		        	if(data.brand!=null){
		        		brandModel +=data.brand.name;
		        	}
		        	if(data.brandModel!=null){
		        		brandModel +=data.brandModel.name;
		        	}
		        	$("#carBrandModel").html(brandModel);
		        	$("#plateNo").html(data.plateNo);
		        	$("#contacts").html(data.contacts);
		        	$("#phone").html(data.phone);
		        	var status = data.status;
		        	var statusStr="正在销售中";
		        	if(status=='1'){
		        		statusStr = "已经卖出";
		        	}
		       $("#status").html(statusStr);
		        }
	     });
		   $('#win').window('open');
	}
	

</script>
</head>
<body>
	
	<div id="win" class="easyui-window" title=""
		style="width: 400px; height: 400px"
		data-options="iconCls:'icon-save',modal:true">
		<div class="easyui-layout" data-options="fit:true">
			<div data-options="region:'center'">
				<div class="easyui-panel" title="车辆信息" style="width: 100%;height:100%">
					<div style="padding: 10px 60px 20px 60px">
							<table cellpadding="5">
								<tr>
								<td>车辆型号:</td>
									<td  id="carBrandModel" >
									</td>
								</tr>
								<tr>
									<td>车牌号码:</td>
									<td id="plateNo" >
									</td>
								</tr>
								<tr>
								<td>联系人:</td>
									<td  id="contacts" >
									</td>
								</tr>
								<tr>
									<td>联系电话:</td>
									<td  id="phone" >
									</td>
								</tr>
									<tr>
									<td>状态:</td>
									<td  id="status" >
									</td>
								</tr>
							</table>
						<div style="text-align: center; padding: 5px">
						<a href="javascript:void(0)" class="easyui-linkbutton" onclick="clearForm()">取消</a>
						</div>
					</div>
				</div>


			</div>
		</div>
	</div>
	
	
	
	<table id="tt"></table>


</body>
</html>
